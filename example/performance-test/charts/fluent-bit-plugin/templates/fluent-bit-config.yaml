---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "fluent-bit-plugin.name" . }}-fluent-bit
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "fluent-bit-plugin.labels" . | nindent 4 }}
data:
  add_tag_to_record.lua: |
    function add_tag_to_record(tag, timestamp, record)
        record["tag"] = tag
        return 1, timestamp, record
    end

  modify_severity.lua: |
    function cb_modify(tag, timestamp, record)
      local unified_severity = cb_modify_unify_severity(record)

      if not unified_severity then
        return 0, 0, 0
      end

      return 1, timestamp, record
    end

    function cb_modify_unify_severity(record)
      local modified = false
      local severity = record["severity"]
      if severity == nil or severity == "" then
    	return modified
      end

      severity = trim(severity):upper()

      if severity == "I" or severity == "INF" or severity == "INFO" then
        record["severity"] = "INFO"
        modified = true
      elseif severity == "W" or severity == "WRN" or severity == "WARN" or severity == "WARNING" then
        record["severity"] = "WARN"
        modified = true
      elseif severity == "E" or severity == "ERR" or severity == "ERROR" or severity == "EROR" then
        record["severity"] = "ERR"
        modified = true
      elseif severity == "D" or severity == "DBG" or severity == "DEBUG" then
        record["severity"] = "DBG"
        modified = true
      elseif severity == "N" or severity == "NOTICE" then
        record["severity"] = "NOTICE"
        modified = true
      elseif severity == "F" or severity == "FATAL" then
        record["severity"] = "FATAL"
        modified = true
      end

      return modified
    end

    function trim(s)
      return (s:gsub("^%s*(.-)%s*$", "%1"))
    end


  parsers.conf: |
    [PARSER]
        Name                containerd-parser
        Format              regex
        Regex               ^(?<time>[^ ]+) (stdout|stderr) ([^ ]*) (?<log>.*)$
        Time_Key            time
        Time_Format         %Y-%m-%dT%H:%M:%S.%L%z
        Time_Keep           true
        Decode_Field_As     json log

  fluent-bit.conf: |
    [Service]
        Daemon          false
        Flush           30
        Http_Listen     0.0.0.0
        Http_Port       2020
        Http_Server     true
        Log_Level       info
        Parsers_File    parsers.conf

    [Input]
        Name   systemd
        Tag    journald.containerd
        Systemd_Filter    _SYSTEMD_UNIT=containerd.service
        Read_From_Tail    on
    [Input]
        Name   systemd
        Tag    journald.kubelet
        Systemd_Filter    _SYSTEMD_UNIT=kubelet.service
        Read_From_Tail    on
    [Input]
        Name    tail
        Path    /var/log/containers/*.log
        Exclude_Path    *_fluent-bit-*.log,*_vali-*.log
        Refresh_Interval    10
        Ignore_Older    30m
        Skip_Long_Lines    true
        DB    /var/fluentbit/flb_kube.db
        Mem_Buf_Limit    30MB
        Tag    kubernetes.*

    [Filter]
        Name    parser
        Match    kubernetes.*
        Key_Name    log
        Parser    containerd-parser
        Reserve_Data    true
    [Filter]
        Name    lua
        Match    kubernetes.*
        script    /fluent-bit/config/add_tag_to_record.lua
        call    add_tag_to_record
    [Filter]
        Name    lua
        Match    kubernetes.*
        script    /fluent-bit/config/modify_severity.lua
        call    cb_modify
    [Filter]
        Name    record_modifier
        Match    journald.containerd
        Record    hostname ${NODE_NAME}
        Record    unit containerd
    [Filter]
        Name    record_modifier
        Match    journald.kubelet
        Record    hostname ${NODE_NAME}
        Record    unit kubelet


    [Output]
        Name gardenervali
        Match kubernetes.*
        Labels {origin="seed"}
        DropSingleKey false
        DynamicHostPath {"kubernetes": {"namespace_name": "namespace"}}
        DynamicHostPrefix http://logging.
        DynamicHostSuffix .svc:3100/vali/api/v1/push
        DynamicHostRegex ^shoot-
        QueueDir /fluent-bit/buffers/seed
        QueueName seed-dynamic
        SendDeletedClustersLogsToDefaultClient true
        CleanExpiredClientsPeriod 1h
        ControllerSyncTimeout 120s
        PreservedLabels origin,namespace_name,pod_name
        LogLevel info
        Url http://logging-vali-seed:3100/vali/api/v1/push
        BatchWait 5s
        BatchSize 1048576
        MaxRetries 5
        Timeout 10s
        MinBackoff 10s
        MaxBackoff 300s
        LineFormat json
        SortByTimestamp true
        DropSingleKey false
        AutoKubernetesLabels false
        HostnameKeyValue nodename ${NODE_NAME}
        Buffer true
        BufferType dque
        QueueSegmentSize 300
        QueueSync normal
        NumberOfBatchIDs 5
        RemoveKeys kubernetes,stream,time,tag,gardenuser,job
        LabelMapPath {"kubernetes": {"container_name":"container_name","container_id":"container_id","namespace_name":"namespace_name","pod_name":"pod_name"},"severity": "severity","job": "job"}
        FallbackToTagWhenMetadataIsMissing true
        TagKey tag
        DropLogEntryWithoutK8sMetadata true

    [Output]
        Name gardenervali
        Match journald.*
        Labels {origin="seed-journald"}
        RemoveKeys kubernetes,stream,hostname,unit
        LabelMapPath {"hostname":"host_name","unit":"systemd_component"}
        QueueDir /fluent-bit/buffers
        QueueName seed-journald
        LogLevel info
        Url http://logging-vali-seed:3100/vali/api/v1/push
        BatchWait 5s
        BatchSize 1048576
        MaxRetries 5
        Timeout 10s
        MinBackoff 10s
        MaxBackoff 300s
        LineFormat json
        SortByTimestamp true
        DropSingleKey false
        AutoKubernetesLabels false
        HostnameKeyValue nodename ${NODE_NAME}
        Buffer true
        BufferType dque
        QueueSegmentSize 300
        QueueSync normal
        NumberOfBatchIDs 5