service:
  flush: 1
  log_level: info
  http_listen: 0.0.0.0
  http_port: 2020
  http_server: true

pipeline:
  inputs:
    - name: tail
      tag: kubernetes.*
      path: "/var/log/containers/*.log"
      readFromHead: true
      parser: "cri"

      processors:
        logs:
          - name: lua
            code: |
              function add_kubernetes_metadata(tag, timestamp, record)
                -- Split the tag into its components
                local stripped_tag = tag:match("kubernetes%.logs%.(.*)%.log")
                local podName, namespaceName, containerName, containerID = stripped_tag:match("([^_]+)_([^_]+)_(.*)%-(.*)")

                record["kubernetes"] = {}
                record["kubernetes"]["pod_name"] = podName
                record["kubernetes"]["namespace_name"] = namespaceName
                record["kubernetes"]["container_name"] = containerName
                record["kubernetes"]["container_id"] = containerID

                -- Add the original tag to the record
                record["tag"] = tag

                return 1, timestamp, record
              end
            call: add_kubernetes_metadata

  outputs:
    - name: gardener
      match: "kubernetes.*"
      seedType: otlphttp
      shootType: otlpgrpc
      dynamicHostPath: '{"kubernetes":{"namespace_name": "" } }'
      dynamicHostRegex: '^logging'
      endpoint: 'seed.svc.cluster.local:4318'
      insecure: true
      dynamicHostSuffix: ':4317'
      logLevel: debug
      hostnameKeyValue: 'nodename ${HOSTNAME}'
      buffer: true
      queueSegmentSize: 10
      queueSync: normal
      queueDir: './buffers'
      queueName: dummy
      tagKey: tag